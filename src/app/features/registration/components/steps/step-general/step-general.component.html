     <div class="branch-header">
    <img routerLink="/" [src]="logo" alt="Company Logo" class="logo-company">
    <h1 routerLink="/" class="app-title">{{title}}</h1>
  </div>


<div class="step-container">
  <div class="header-section">
    <div class="title-wrapper">
      <h1 class="main-title">
        <span class="highlight">{{'visitor' | translate}}</span>
        <br>
        <span class="normal">{{'information' | translate}}</span>
      </h1>
      <p class="subtitle">{{'please_provide_your_details' | translate}}</p>
    </div>
    <p-button type="button" [label]="'returning_visitor' | translate" icon="pi pi-user" [outlined]="true"
      styleClass="returning-guest-btn" (onClick)="onExistingGuestClick()">
    </p-button>
  </div>

  <!-- Loading State -->
  @if (isLoading) {
  <div class="loading-container">
    <div class="loading-spinner">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Loading form...</p>
    </div>
  </div>
  }

  <!-- Form Content -->
  @if (!isLoading) {
  <div class="step-content">
    @if (settings && udfSettings !== null) {
    <form [formGroup]="generalForm" class="form-grid">

      <!-- Profile Picture -->
      @if (settings?.ImageUploadEnabled) {
      <div class="form-field">
        <label class="field-label">
          {{'upload_photo' | translate}}
          <span class="required-star">{{settings?.ImageUploadRequired ? '*' : ''}}</span>
        </label>
        <div class="profile-upload" (click)="fileInput.click()" [class.invalid]="isFieldInvalidRequired('profile')">
          <input #fileInput type="file" accept="image/*" hidden (change)="handleFileUpload($event)">
          @if (profileImage) {
          <img [src]="profileImage" class="profile-image" alt="Profile">
          } @else {
          <div class="upload-placeholder">
            <button type="button" pButton label="Choose file" class="p-button-outlined"></button>
            <span>No file chosen</span>
          </div>
          }
        </div>
        @if (isFieldInvalidRequired('profile')) {
        <small class="error-message">Profile picture is required</small>
        }
      </div>
      }

      <!-- Phone -->
      @if (settings?.ContactNumberEnabled) {
      <div class="form-field">
        <label class="field-label" for="phone">
          {{'contact_number' | translate}}
          <span class="required-star">{{settings?.ContactNumberRequired ? '*' : ''}}</span>
        </label>
        <input pInputText id="phone" [placeholder]="'contact_number' | translate:'placeholder'" formControlName="phone"
          [class.error]="isFieldInvalidRequired('phone')" [disabled]="isFieldDisabled('phone')">
        @if (isFieldInvalidRequired('phone')) {
        <small class="error-message">Valid mobile number is required</small>
        }
      </div>
      }

      <!-- Full Name -->
      @if (settings?.NameEnabled) {
      <div class="form-field">
        <label class="field-label" for="fullName">
          {{'full_name' | translate}}
          <span class="required-star">{{settings?.NameRequired ? '*' : ''}}</span>
        </label>
        <input pInputText id="fullName" [placeholder]="'full_name' | translate:'placeholder'" formControlName="fullName"
          [class.error]="isFieldInvalidRequired('fullName')" [disabled]="isFieldDisabled('fullName')">
        @if (isFieldInvalidRequired('fullName')) {
        <small class="error-message">Full name is required</small>
        }
      </div>
      }

      <!-- Host -->
      @if (settings?.HostNameEnabled && !shouldHideHostControl && !isFieldHiddenInAppointmentFlow('host')) {
      <div class="form-field">
        <label class="field-label" for="host">
          {{'whom_you_would_like_to_visit' | translate}}
          <span class="required-star">{{settings?.HostNameRequired && !isAppointmentFlow ? '*' : ''}}</span>
        </label>
        <p-select id="host" [options]="hosts" formControlName="host"
          [placeholder]="'whom_you_would_like_to_visit' | translate:'placeholder'" (onChange)="onHostChange($event)"
          optionLabel="HOSTNAME" optionValue="HOSTIC" [class.error]="isFieldInvalidRequired('host')"
          [disabled]="isFieldDisabled('host')">
        </p-select>
        @if (isFieldInvalidRequired('host')) {
        <small class="error-message">Please select a host</small>
        }
      </div>
      }

      <!-- Email -->
      @if (settings?.EmailEnabled) {
      <div class="form-field">
        <label class="field-label" for="email">
          {{'email_address' | translate}}
          <span class="required-star">{{settings?.EmailRequired ? '*' : ''}}</span>
        </label>
        <input pInputText id="email" [placeholder]="'email_address' | translate:'placeholder'" formControlName="email"
          type="email" [class.error]="isFieldInvalidRequired('email')" [disabled]="isFieldDisabled('email')">
        @if (isFieldInvalidRequired('email')) {
        <small class="error-message">Valid email is required</small>
        }
      </div>
      }

      <!-- Visit Date -->
      @if (settings?.StartEndDtEnabled) {
      <div class="form-field">
        <label class="field-label" for="visitDate">
          {{'visit_date' | translate}}
          <span class="required-star">*</span>
        </label>
        <p-datepicker id="visitDate" formControlName="visitDate" [showIcon]="true"
          [class.error]="isFieldInvalidRequired('visitDate')" [minDate]="minDate" [placeholder]="'dd/mm/yyyy'"
          [showTime]="false" appendTo="body">
        </p-datepicker>
        @if (isFieldInvalidRequired('visitDate')) {
        <small class="error-message">Please select visit date</small>
        }
      </div>
      }

      <!-- Visit Time -->
      @if (settings?.StartEndDtEnabled) {
      <div class="form-field">
        <label class="field-label" for="visitTime">
          {{'visit_time' | translate}}
        </label>
        <p-datepicker id="visitTime" formControlName="visitTime" [showIcon]="true" iconDisplay="input" [timeOnly]="true"
          hourFormat="12" [placeholder]="'--:-- --'" [class.error]="isFieldInvalidRequired('visitTime')"
          appendTo="body">
          <ng-template #inputicon let-clickcallback="clickCallback">
            <i class="pi pi-clock" (click)="clickcallback($event)"></i>
          </ng-template>
        </p-datepicker>
      </div>
      }

      <!-- Identity Number -->
      @if (settings?.IdProofEnabled) {
      <div class="form-field">
        <label class="field-label" for="visitor_id">
          {{'identity_number' | translate}}
          <span class="required-star">{{settings?.IdProofRequired ? '*' : ''}}</span>
        </label>
        <input pInputText id="visitor_id" [placeholder]="'identity_number' | translate:'placeholder'"
          formControlName="visitor_id" [class.error]="isFieldInvalidRequired('visitor_id')"
          [disabled]="isFieldDisabled('visitor_id')">
        @if (isFieldInvalidRequired('visitor_id')) {
        <small class="error-message">Visitor ID is required</small>
        }
      </div>
      }

      <!-- ID Type -->
      @if (settings?.IdTypeEnabled) {
      <div class="form-field">
        <label class="field-label" for="id_type">
          {{'id_type' | translate}}
          <span class="required-star">{{settings?.IdTypeRequired ? '*' : ''}}</span>
        </label>
        <p-select id="id_type" [options]="idTypeList" formControlName="visitor_id_type"
          [placeholder]="'id_type' | translate:'placeholder'" optionLabel="IDTYPEDESCRIPTION" optionValue="ID_TYPECODE"
          [class.error]="isFieldInvalidRequired('visitor_id_type')" [disabled]="isFieldDisabled('visitor_id_type')"
          (onChange)="onIdTypeChange($event)">
        </p-select>
        @if (isFieldInvalidRequired('visitor_id_type')) {
        <small class="error-message">ID Type is required</small>
        }
      </div>
      }

      <!-- Title -->
      @if (settings?.TitleEnabled) {
      <div class="form-field">
        <label class="field-label" for="title_name">
          {{'title' | translate }}
          <span class="required-star">{{settings?.TitleRequired ? '*' : ''}}</span>
        </label>
        <p-select id="title_name" [options]="titleList" formControlName="title"
          [placeholder]="'title' | translate:'placeholder'" optionLabel="Title" optionValue="Title"
          [class.error]="isFieldInvalidRequired('title')" [disabled]="isFieldDisabled('title')">
        </p-select>
        @if (isFieldInvalidRequired('title')) {
        <small class="error-message">Please select a Title</small>
        }
      </div>
      }

      <!-- Department -->
      @if (settings?.HostDepartmentEnabled) {
      <div class="form-field">
        <label class="field-label" for="department">
          {{'department' | translate}}
          <span class="required-star">{{settings?.HostDepartmentRequired ? '*' : ''}}</span>
        </label>
        <p-select id="department" [options]="departmentList" formControlName="department"
          [placeholder]="'department' | translate:'placeholder'"
          [optionLabel]="departmentList[0]?.DName ? 'DName' : 'Department'"
          [optionValue]="departmentList[0]?.DepartmentSeqId ? 'DepartmentSeqId' : 'Department'"
          [class.error]="isFieldInvalidRequired('department')" [disabled]="isFieldDisabled('department')"
          (onChange)="onDepartmentChange($event)">
        </p-select>
        @if (isFieldInvalidRequired('department')) {
        <small class="error-message">Please select a department</small>
        }
      </div>
      }

      <!-- Gender -->
      @if (settings?.GenderEnabled) {
      <div class="form-field">
        <label class="field-label" for="gender">
          {{'gender' | translate}}
          <span class="required-star">{{settings?.GenderRequired ? '*' : ''}}</span>
        </label>
        <p-select id="gender" [options]="genderOptions" formControlName="gender"
          [placeholder]="'gender' | translate:'placeholder'" optionLabel="Name" optionValue="Value"
          [class.error]="isFieldInvalidRequired('gender')" [disabled]="isFieldDisabled('gender')">
        </p-select>
        @if (isFieldInvalidRequired('gender')) {
        <small class="error-message">Please select gender</small>
        }
      </div>
      }

      <!-- Company -->
      @if (settings?.CompanyEnabled) {
      <div class="form-field">
        <label class="field-label" for="visitor_company">
          {{'company' | translate}}
          <span class="required-star">{{settings?.CompanyRequired ? '*' : ''}}</span>
        </label>
        <p-autoComplete id="visitor_company" [suggestions]="companyList" (completeMethod)="searchCompany($event)"
          (onSelect)="onCompanySelect($event)" field="visitor_comp_name" optionLabel="visitor_comp_name"
          dataKey="visitor_comp_name" formControlName="visitor_company"
          [placeholder]="'company' | translate:'placeholder'" [dropdown]="true" [forceSelection]="false"
          [class.error]="isFieldInvalidRequired('visitor_company')" [disabled]="isFieldDisabled('visitor_company')">
        </p-autoComplete>
        @if (isFieldInvalidRequired('visitor_company')) {
        <small class="error-message">Company is required</small>
        }
      </div>
      }

      <!-- Vehicle Number -->
      @if (settings?.VehicleNumberEnabled) {
      <div class="form-field">
        <label class="field-label" for="vehicle_number">
          {{'vehicle_number' | translate}}
          <span class="required-star">{{settings?.VehicleNumberRequired ? '*' : ''}}</span>
        </label>
        <input pInputText id="vehicle_number" [placeholder]="'vehicle_number' | translate:'placeholder'"
          formControlName="vehicle_number" [class.error]="isFieldInvalidRequired('vehicle_number')"
          [disabled]="isFieldDisabled('vehicle_number')">
        @if (isFieldInvalidRequired('vehicle_number')) {
        <small class="error-message">Vehicle Number is required</small>
        }
      </div>
      }

      <!-- Country -->
      @if (settings?.CountryEnabled) {
      <div class="form-field">
        <label class="field-label" for="country">
          {{'country' | translate}}
          <span class="required-star">{{settings?.CountryRequired ? '*' : ''}}</span>
        </label>
        <p-select id="country" [options]="countryList" formControlName="country"
          [placeholder]="'country' | translate:'placeholder'" optionLabel="Name" optionValue="CountrySeqId"
          [class.error]="isFieldInvalidRequired('country')" [disabled]="isFieldDisabled('country')">
        </p-select>
        @if (isFieldInvalidRequired('country')) {
        <small class="error-message">Please select your Country</small>
        }
      </div>
      }

      <!-- Remarks -->
      @if (settings?.RemarksEnabled) {
      <div class="form-field">
        <label class="field-label" for="remarks">
          {{'would_you_like_to_add_comments_for_your_visit?' | translate}}
          <span class="required-star">{{settings?.RemarksRequired ? '*' : ''}}</span>
        </label>
        <textarea pInputText id="remarks" cols="3" rows="1"
          [placeholder]="'would_you_like_to_add_comments_for_your_visit?' | translate:'placeholder'"
          formControlName="remarks" [class.error]="isFieldInvalidRequired('remarks')"
          [disabled]="isFieldDisabled('remarks')">
        </textarea>
        @if (isFieldInvalidRequired('remarks')) {
        <small class="error-message">Remarks is required</small>
        }
      </div>
      }

      <!-- VIMS Appointment Time Slot Section -->
      @if (enableVimsApptTimeSlot && !enableFBInSelfReg) {
      <div class="form-field">
        <label class="field-label" for="appointmentDate">
          Appointment Date <span class="required-star">*</span>
        </label>
        <p-datepicker id="appointmentDate" formControlName="appointmentDate" [showIcon]="true"
          [class.error]="isFieldInvalidRequired('appointmentDate')" [minDate]="minDate"
          placeholder="Select appointment date" [showTime]="false" (onSelect)="onAppointmentDateSelect($event)"
          appendTo="body">
        </p-datepicker>
        @if (isFieldInvalidRequired('appointmentDate')) {
        <small class="error-message">Please select appointment date</small>
        }
      </div>
      }

      @if (enableVimsApptTimeSlot && !enableFBInSelfReg && timeSlotList.length > 0) {
      <div class="form-field">
        <label class="field-label" for="timeSlot">
          Time Slot <span class="required-star">*</span>
        </label>
        <p-select id="timeSlot" [options]="timeSlotList" formControlName="timeSlot" placeholder="Select time slot"
          optionLabel="Name" optionValue="Code" (onChange)="onTimeslotChange($event)"
          [class.error]="isFieldInvalidRequired('timeSlot')">
        </p-select>
        @if (isFieldInvalidRequired('timeSlot')) {
        <small class="error-message">Please select a time slot</small>
        }
      </div>
      }

      <!-- Shared Date Picker for both flows -->
      @if ((enableVimsApptTimeSlot && enableFBInSelfReg) || (enableFBInSelfReg &&
      generalForm.get('facilityBooking')?.value)) {
      <div class="form-field">
        <label class="field-label" for="sharedDate">
          Date <span class="required-star">*</span>
        </label>
        <p-datepicker id="sharedDate" formControlName="sharedDate" [showIcon]="true"
          [class.error]="isFieldInvalidRequired('sharedDate')" [minDate]="minDate" placeholder="Select date"
          [showTime]="false" (onSelect)="onSharedDateSelect($event)" appendTo="body">
        </p-datepicker>
        @if (isFieldInvalidRequired('sharedDate')) {
        <small class="error-message">Please select date</small>
        }
      </div>
      }

      @if (enableFBInSelfReg && generalForm.get('facilityBooking')?.value) {
      <div class="form-field">
        <label class="field-label" for="facilityPurpose">
          Purpose <span class="required-star">*</span>
        </label>
        <p-select id="facilityPurpose" [options]="facilityPurposeList" formControlName="facilityPurpose"
          placeholder="Select purpose" optionLabel="PurposeName" optionValue="PurposeCode"
          [class.error]="isFieldInvalidRequired('facilityPurpose')">
        </p-select>
        @if (isFieldInvalidRequired('facilityPurpose')) {
        <small class="error-message">Please select a purpose</small>
        }
      </div>
      }

      @if (enableFBInSelfReg && generalForm.get('facilityBooking')?.value) {
      <div class="form-field">
        <label class="field-label" for="facilitySelection">
          Facility <span class="required-star">*</span>
        </label>
        <p-select id="facilitySelection" [options]="facilityMasterList" formControlName="facilitySelection"
          placeholder="Select facility" optionLabel="FacilityName" optionValue="FacilityCode"
          (onChange)="onFacilitySelectionChange($event.value)"
          [class.error]="isFieldInvalidRequired('facilitySelection')">
        </p-select>
        @if (isFieldInvalidRequired('facilitySelection')) {
        <small class="error-message">Please select a facility</small>
        }
      </div>
      }

      <!-- Time Slot Selection for VIMS when both features are enabled -->
      @if (enableVimsApptTimeSlot && enableFBInSelfReg && !generalForm.get('facilityBooking')?.value &&
      timeSlotList.length > 0) {
      <div class="form-field">
        <label class="field-label" for="timeSlot">
          Time Slot <span class="required-star">*</span>
        </label>
        <p-select id="timeSlot" [options]="timeSlotList" formControlName="timeSlot" placeholder="Select time slot"
          optionLabel="Name" optionValue="Code" (onChange)="onTimeslotChange($event)"
          [class.error]="isFieldInvalidRequired('timeSlot')">
        </p-select>
        @if (isFieldInvalidRequired('timeSlot')) {
        <small class="error-message">Please select a time slot</small>
        }
      </div>
      }

      <!-- Facility Booking Slots Display -->
      @if (enableFBInSelfReg && generalForm.get('facilityBooking')?.value && facilityBookingSlots.length > 0) {
      <div class="form-field full-width">
        <label class="field-label">Available Booking Slots</label>
        <div class="booking-legend">
          <div class="legend-item">
            <div class="legend-color available"></div>
            <span class="legend-text">Available</span>
          </div>
          <div class="legend-item">
            <div class="legend-color booked"></div>
            <span class="legend-text">Booked</span>
          </div>
          <div class="legend-item">
            <div class="legend-color expired"></div>
            <span class="legend-text">Expired</span>
          </div>
          <div class="legend-item">
            <div class="legend-color selected"></div>
            <span class="legend-text">Selected</span>
          </div>
        </div>
        <div class="booking-slots-container" id="showbookings">
          <div class="slots-grid">
            @for (timeGroup of facilityBookingSlots; track timeGroup) {
            <div class="slot-row">
              <div class="slot-items">
                @for (slot of timeGroup.slots; track slot) {
                <div class="booking-slot" [class]="getSlotCssClass(slot)" [title]="slot.StaffID"
                  [attr.data-ref]="slot.StartTime + ',' + slot.EndTime" (click)="bookingSlotClick($event, slot)">
                  <div class="slot-content">
                    <div class="slot-time">{{getSlotTimeDisplay(slot.StartTime, slot.EndTime)}}</div>
                    @if (slot.BookingID) {
                    <div class="slot-status">Booked</div>
                    }
                  </div>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </div>
      }

      <!-- Dynamic UDF fields -->
      @for (udf of udfSettings; track udf) {
      @if (udf.Enabled) {
      <!-- Text Input (UDFCtrlType = 10) -->
      @if (udf.UDFCtrlType === 10) {
      <div class="form-field">
        <label class="field-label" [for]="udf.UDFName">
          {{udf.Caption}}
          <span class="required-star">{{(settings[udf.UDFName + "Required"]) ? '*' : ''}}</span>
        </label>
        <input pInputText [id]="udf.UDFName" [placeholder]="udf.Placeholder | translate:'placeholder'"
          [formControlName]="udf.UDFName" [maxlength]="udf.MaxLength"
          [class.error]="isFieldInvalidRequired(udf.UDFName)">
        @if (isFieldRequired(udf.UDFName)) {
        <small class="error-message">{{udf.Caption}} is required</small>
        }
        @if (isFieldInvalid(udf.UDFName)) {
        <small class="error-message">{{udf.Caption}} is invalid</small>
        }
      </div>
      }
      <!-- Single Select Dropdown (UDFCtrlType = 20) -->
      @if (udf.UDFCtrlType === 20) {
      <div class="form-field">
        <label class="field-label" [for]="udf.UDFName">
          {{udf.Caption}}
          <span class="required-star">{{(settings[udf.UDFName + "Required"]) ? '*' : ''}}</span>
        </label>
        <p-select [id]="udf.UDFName" [options]="getUdfOptions(udf.apptUDFSetSeqId)" [formControlName]="udf.UDFName"
          [placeholder]="udf.Placeholder" optionLabel="label" optionValue="value"
          [class.error]="isFieldInvalidRequired(udf.UDFName)">
        </p-select>
        @if (isFieldInvalidRequired(udf.UDFName)) {
        <small class="error-message">Please select {{udf.Caption}}</small>
        }
      </div>
      }
      <!-- Multi-Select Dropdown (UDFCtrlType = 30) -->
      @if (udf.UDFCtrlType === 30) {
      <div class="form-field">
        <label class="field-label" [for]="udf.UDFName">
          {{udf.Caption}}
          <span class="required-star">{{(settings[udf.UDFName + "Required"]) ? '*' : ''}}</span>
        </label>
        <p-multiSelect [id]="udf.UDFName" [options]="getUdfOptions(udf.apptUDFSetSeqId)" [formControlName]="udf.UDFName"
          [placeholder]="udf.Placeholder" optionLabel="label" optionValue="value"
          [class.error]="isFieldInvalidRequired(udf.UDFName)">
        </p-multiSelect>
        @if (isFieldInvalidRequired(udf.UDFName)) {
        <small class="error-message">Please select at least one {{udf.Caption}}</small>
        }
      </div>
      }
      }
      }

      <!-- Add Visitor Button (only when multiple visitor setting is enabled) -->
      @if (settings?.MultipleVisitorEnabled) {
      <div class="add-visitor-section full-width">
        <p-button type="button" icon="pi pi-plus"
          [label]="editingVisitorIndex >= 0 ? ('update_visitor' | translate) : ('add_guest' | translate)"
          (onClick)="addVisitorToTable()" styleClass="add-guest-btn" [disabled]="!isCurrentVisitorFormValid()">
        </p-button>
        @if (editingVisitorIndex >= 0) {
        <p-button type="button" icon="pi pi-times" label="Cancel" (onClick)="cancelEdit()" [outlined]="true"
          severity="secondary">
        </p-button>
        }
      </div>
      }

    </form>

    <!-- Saved Visitors Table -->
    @if (settings?.MultipleVisitorEnabled && savedVisitors.length > 0) {
    <div class="saved-visitors-section">
      <h4 class="saved-title">{{'saved_visitors' | translate}}</h4>

      @for (visitor of savedVisitors; track visitor; let i = $index) {
      <div class="saved-visitor-card">
        <div class="saved-content">
          @if (settings?.ImageUploadEnabled) {
          <div class="saved-photo">
            <i class="pi pi-camera"></i>
            <span>Upload Your Photo</span>
          </div>
          }
          <div class="saved-info">
            <i class="pi pi-phone"></i>
            <span>{{visitor.phone || 'No phone'}}</span>
          </div>
        </div>
        <div class="saved-actions">
          <button class="action-btn edit-btn" (click)="editSavedVisitor(i)" title="Edit">
            <i class="pi pi-pencil"></i>
          </button>
          <button class="action-btn delete-btn" (click)="deleteSavedVisitor(i)" title="Delete">
            <i class="pi pi-trash"></i>
          </button>
        </div>
      </div>
      }
    </div>
    }

    }
  </div>
  }

</div>

<p-dialog [(visible)]="showReturningVisitorPopup" [modal]="true" [draggable]="false" [resizable]="false"
  styleClass="search-profile-dialog" [showHeader]="false">
  <div class="search-profile-container">
    <button type="button" class="close-btn" (click)="showReturningVisitorPopup = false">
      <i class="pi pi-times"></i>
    </button>
    <h2 class="dialog-title">Search Profile</h2>
    <div class="search-input-wrapper">
      <input pInputText type="text" [(ngModel)]="searchQuery" [placeholder]="'Enter Phone Number, Email, or NRIC ...'"
        (keyup.enter)="searchProfile()">
    </div>
    <button pButton type="button" class="search-btn" label="Search Profile" (click)="searchProfile()">
    </button>
  </div>
</p-dialog>